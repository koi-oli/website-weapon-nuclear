name: Ubuntu VNC local

on: [workflow_dispatch]

jobs:
  tunnel:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          sudo apt update
          sudo DEBIAN_FRONTEND=noninteractive apt install -y \
            xfce4 xfce4-goodies x11vnc git \
            tigervnc-standalone-server firefox net-tools curl
          
          # Install Node.js and LocalTunnel
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt install -y nodejs
          sudo npm install -g localtunnel
          
      - name: Start Xvfb display
        run: |
          Xvfb :1 -screen 0 1920x1080x24 &
          sleep 5
          export DISPLAY=:1
          echo "DISPLAY=:1" >> $GITHUB_ENV
          
      - name: Start XFCE session
        run: |
          export DISPLAY=:1
          startxfce4 &
          sleep 10
          
      - name: Configure VNC password
        run: |
          mkdir -p ~/.vnc
          echo "password" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          
      - name: Start VNC server
        run: |
          export DISPLAY=:1
          x11vnc -display :1 -rfbauth ~/.vnc/passwd -forever -shared -rfbport 5900 &
          sleep 5
          
      - name: Install noVNC
        run: |
          git clone https://github.com/novnc/noVNC.git ~/noVNC
          git clone https://github.com/novnc/websockify.git ~/noVNC/utils/websockify
          
      - name: Start noVNC
        run: |
          cd ~/noVNC
          ./utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
          sleep 5
          
      - name: Verify services
        run: |
          echo "Checking running processes:"
          ps aux | grep -E "(Xvfb|xfce|x11vnc|novnc)" | grep -v grep
          echo ""
          echo "Checking listening ports:"
          netstat -tlnp | grep -E "(5900|6080)"
          
      - name: Get tunnel password
        run: |
          PUBLIC_IP=$(curl -s https://api.ipify.org)
          echo "PUBLIC_IP=${PUBLIC_IP}" >> $GITHUB_ENV
          echo "Your tunnel password: ${PUBLIC_IP}"
          
      - name: Open LocalTunnel
        run: |
          echo "Opening tunnel via LocalTunnel..."
          
          lt --port 6080 > /tmp/localtunnel.log 2>&1 &
          
          sleep 10
          
          TUNNEL_URL=$(grep -oE 'https://[a-z0-9-]+\.loca\.lt' /tmp/localtunnel.log | head -1)
          
          echo "============================================"
          echo "üì° LOCALTUNNEL URL"
          echo "============================================"
          echo ""
          echo "üåê Web (noVNC): ${TUNNEL_URL}/vnc.html"
          echo ""
          echo "üîë TUNNEL PASSWORD: ${PUBLIC_IP}"
          echo ""
          echo "üìã HOW TO CONNECT:"
          echo "1. Open: ${TUNNEL_URL}/vnc.html"
          echo "2. Enter tunnel password: ${PUBLIC_IP}"
          echo "3. Click 'Click to Submit'"
          echo "4. Click 'Connect' button"
          echo "5. Enter VNC password: password"
          echo "============================================"
          
          echo ""
          echo "Tunnel log:"
          cat /tmp/localtunnel.log
          
          echo ""
          echo "‚úÖ Keeping alive for 6 hours..."
          sleep 21600
