name: Ubuntu VNC

on: [workflow_dispatch]

permissions:
  contents: write  # Required for pushing commits

jobs:
  tunnel:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: Install dependencies
        run: |
          sudo apt update
          sudo DEBIAN_FRONTEND=noninteractive apt install -y \
            xfce4 xfce4-goodies x11vnc git openssh-client \
            tigervnc-standalone-server firefox net-tools rsync
          
      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          git config --global push.default current
          
      - name: Create Desktop directory
        run: |
          mkdir -p /home/runner/Desktop
          chmod 755 /home/runner/Desktop
          
      - name: Restore previous Desktop state
        run: |
          if [ -d "desktop_backup" ]; then
            echo "Restoring previous Desktop state..."
            cp -r desktop_backup/* /home/runner/Desktop/ 2>/dev/null || true
            echo "Desktop restored!"
          else
            echo "No previous Desktop state found. Starting fresh."
            mkdir -p desktop_backup
          fi
          
      - name: Start Xvfb display
        run: |
          Xvfb :1 -screen 0 1920x1080x24 &
          sleep 5
          export DISPLAY=:1
          echo "DISPLAY=:1" >> $GITHUB_ENV
          
      - name: Start XFCE session
        run: |
          export DISPLAY=:1
          startxfce4 &
          sleep 10
          
      - name: Configure VNC password
        run: |
          mkdir -p ~/.vnc
          echo "password" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          
      - name: Start VNC server
        run: |
          export DISPLAY=:1
          x11vnc -display :1 -rfbauth ~/.vnc/passwd -forever -shared -rfbport 5900 &
          sleep 5
          
      - name: Install noVNC
        run: |
          git clone https://github.com/novnc/noVNC.git ~/noVNC
          git clone https://github.com/novnc/websockify.git ~/noVNC/utils/websockify
          
      - name: Start noVNC
        run: |
          cd ~/noVNC
          ./utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
          sleep 5
          
      - name: Verify services
        run: |
          echo "Checking running processes:"
          ps aux | grep -E "(Xvfb|xfce|x11vnc|novnc)" | grep -v grep
          echo ""
          echo "Checking listening ports:"
          netstat -tlnp | grep -E "(5900|6080)"
          
      - name: Start Desktop sync service
        run: |
          # Create sync script
          cat > /tmp/desktop_sync.sh << 'SYNCEOF'
          #!/bin/bash
          
          DESKTOP_DIR="/home/runner/Desktop"
          REPO_DIR="${GITHUB_WORKSPACE}"
          BACKUP_DIR="${REPO_DIR}/desktop_backup"
          
          echo "=========================================="
          echo "üîÑ Desktop Sync Service Started"
          echo "=========================================="
          echo "Desktop Dir: $DESKTOP_DIR"
          echo "Backup Dir: $BACKUP_DIR"
          echo "Repository: $REPO_DIR"
          echo "=========================================="
          
          # Ensure backup directory exists
          mkdir -p "$BACKUP_DIR"
          
          SYNC_COUNT=0
          
          # Function to sync Desktop to repo
          sync_desktop() {
            SYNC_COUNT=$((SYNC_COUNT + 1))
            echo ""
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] üîç Sync check #${SYNC_COUNT}"
            
            # Check if Desktop directory has any files
            FILE_COUNT=$(find "$DESKTOP_DIR" -type f 2>/dev/null | wc -l)
            echo "Files in Desktop: $FILE_COUNT"
            
            if [ "$FILE_COUNT" -gt 0 ]; then
              echo "üì¶ Syncing Desktop contents..."
              
              # Show what files exist
              echo "Files to sync:"
              ls -lah "$DESKTOP_DIR"
              
              # Sync Desktop contents to backup directory
              rsync -av --delete "$DESKTOP_DIR/" "$BACKUP_DIR/" 2>&1
              
              cd "$REPO_DIR"
              
              # Add all changes
              git add -A desktop_backup/
              
              # Check if there are changes to commit
              if ! git diff --staged --quiet 2>/dev/null; then
                echo "üìù Committing changes..."
                
                # Commit changes
                git commit -m "Auto-sync Desktop - $(date '+%Y-%m-%d %H:%M:%S') - ${FILE_COUNT} files" 2>&1
                
                # Try to push with retries
                for i in {1..3}; do
                  echo "Attempting push (attempt $i/3)..."
                  
                  # Pull with rebase first
                  git pull --rebase origin main 2>&1 || git pull --rebase origin master 2>&1 || true
                  
                  # Push changes
                  if git push 2>&1; then
                    echo "‚úÖ Desktop synced successfully!"
                    break
                  else
                    echo "‚ö†Ô∏è  Push failed, retrying in 5 seconds..."
                    sleep 5
                  fi
                done
              else
                echo "‚ÑπÔ∏è  No new changes to commit"
              fi
            else
              echo "‚ÑπÔ∏è  Desktop is empty, nothing to sync"
            fi
          }
          
          # Initial sync
          echo ""
          echo "üöÄ Performing initial sync..."
          sync_desktop
          
          # Sync every minute
          echo ""
          echo "‚è∞ Starting minute-by-minute sync..."
          while true; do
            sleep 60
            sync_desktop
          done
          SYNCEOF
          
          chmod +x /tmp/desktop_sync.sh
          
          # Start sync service in background
          /tmp/desktop_sync.sh 2>&1 | tee /tmp/desktop_sync.log &
          
          sleep 3
          
          echo "‚úÖ Desktop sync service started!"
          echo "üìÅ Syncing /home/runner/Desktop/ to repository every minute"
          echo "üìã View logs: tail -f /tmp/desktop_sync.log"
          
      - name: Open Serveo tunnel and keep alive
        run: |
          echo "Opening web tunnel via Serveo..."
          
          ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=60 \
              -R 80:localhost:6080 serveo.net 2>&1 | tee /tmp/serveo-web.log &
          
          sleep 10
          
          echo "============================================"
          echo "üì° SERVEO TUNNEL URL"
          echo "============================================"
          
          WEB_URL=$(grep -oE 'https://[a-z0-9]+\.serveo\.net' /tmp/serveo-web.log | head -1)
          
          echo "üåê Web (noVNC): ${WEB_URL}/vnc.html"
          echo ""
          echo "üìã HOW TO CONNECT:"
          echo "1. Open: ${WEB_URL}/vnc.html"
          echo "2. Click 'Connect'"
          echo "3. Enter password: password"
          echo ""
          echo "üíæ DESKTOP SYNC STATUS:"
          echo "‚Ä¢ Auto-sync: ENABLED ‚úÖ"
          echo "‚Ä¢ Frequency: Every 60 seconds"
          echo "‚Ä¢ Location: /home/runner/Desktop/"
          echo "‚Ä¢ Backup folder: desktop_backup/"
          echo ""
          echo "üîç Monitor sync activity:"
          echo "   tail -f /tmp/desktop_sync.log"
          echo "============================================"
          
          echo ""
          echo "Tunnel log:"
          cat /tmp/serveo-web.log
          
          echo ""
          echo "‚úÖ Session active! Keeping alive for 6 hours..."
          echo "üìÅ Desktop syncing every minute in background"
          echo ""
          
          # Show sync log output every 5 minutes
          for i in {1..72}; do
            sleep 300  # 5 minutes
            echo ""
            echo "=== Sync Status Update ($(date)) ==="
            tail -20 /tmp/desktop_sync.log
            echo "===================================="
          done
          
      - name: Final Desktop sync
        if: always()
        run: |
          echo ""
          echo "============================================"
          echo "üîÑ FINAL SYNC BEFORE SHUTDOWN"
          echo "============================================"
          
          DESKTOP_DIR="/home/runner/Desktop"
          BACKUP_DIR="${GITHUB_WORKSPACE}/desktop_backup"
          
          FILE_COUNT=$(find "$DESKTOP_DIR" -type f 2>/dev/null | wc -l)
          echo "Files in Desktop: $FILE_COUNT"
          
          if [ "$FILE_COUNT" -gt 0 ]; then
            echo "üì¶ Performing final sync..."
            ls -lah "$DESKTOP_DIR"
            
            mkdir -p "$BACKUP_DIR"
            rsync -av --delete "$DESKTOP_DIR/" "$BACKUP_DIR/"
            
            cd "${GITHUB_WORKSPACE}"
            git add -A desktop_backup/
            
            if ! git diff --staged --quiet; then
              git commit -m "üîö Final Desktop sync - $(date '+%Y-%m-%d %H:%M:%S') - ${FILE_COUNT} files"
              git pull --rebase origin main 2>/dev/null || git pull --rebase origin master 2>/dev/null || true
              git push || echo "‚ö†Ô∏è  Final push failed"
              echo "‚úÖ Final sync complete!"
            else
              echo "‚ÑπÔ∏è  No changes to sync"
            fi
          else
            echo "‚ÑπÔ∏è  Desktop is empty"
          fi
          
          echo ""
          echo "üìä Full sync log:"
          cat /tmp/desktop_sync.log
          echo "============================================"
