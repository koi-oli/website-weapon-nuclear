name: Ubuntu VNC

on: [workflow_dispatch]

permissions:
  contents: write

jobs:
  tunnel:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: Install dependencies
        run: |
          sudo apt update
          sudo DEBIAN_FRONTEND=noninteractive apt install -y \
            xfce4 xfce4-goodies x11vnc git openssh-client \
            tigervnc-standalone-server firefox net-tools rsync curl
          
          # Install Node.js and LocalTunnel
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt install -y nodejs
          sudo npm install -g localtunnel
          
      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          git config --global push.default current
          
      - name: Create Desktop directory
        run: |
          mkdir -p /home/runner/Desktop
          chmod 755 /home/runner/Desktop
          
      - name: Restore previous Desktop state
        run: |
          if [ -d "desktop_backup" ]; then
            echo "Restoring previous Desktop state..."
            cp -r desktop_backup/* /home/runner/Desktop/ 2>/dev/null || true
            echo "Desktop restored!"
          else
            echo "No previous Desktop state found. Starting fresh."
            mkdir -p desktop_backup
          fi
          
      - name: Start Xvfb display
        run: |
          Xvfb :1 -screen 0 1920x1080x24 &
          sleep 5
          export DISPLAY=:1
          echo "DISPLAY=:1" >> $GITHUB_ENV
          
      - name: Start XFCE session
        run: |
          export DISPLAY=:1
          startxfce4 &
          sleep 10
          
      - name: Configure VNC password
        run: |
          mkdir -p ~/.vnc
          echo "password" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          
      - name: Start VNC server
        run: |
          export DISPLAY=:1
          x11vnc -display :1 -rfbauth ~/.vnc/passwd -forever -shared -rfbport 5900 &
          sleep 5
          
      - name: Install noVNC
        run: |
          git clone https://github.com/novnc/noVNC.git ~/noVNC
          git clone https://github.com/novnc/websockify.git ~/noVNC/utils/websockify
          
      - name: Start noVNC
        run: |
          cd ~/noVNC
          ./utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
          sleep 5
          
      - name: Verify services
        run: |
          echo "Checking running processes:"
          ps aux | grep -E "(Xvfb|xfce|x11vnc|novnc)" | grep -v grep
          echo ""
          echo "Checking listening ports:"
          netstat -tlnp | grep -E "(5900|6080)"
          
      - name: Start Desktop sync service
        run: |
          cat > /tmp/desktop_sync.sh << 'SYNCEOF'
          #!/bin/bash
          
          DESKTOP_DIR="/home/runner/Desktop"
          REPO_DIR="${GITHUB_WORKSPACE}"
          BACKUP_DIR="${REPO_DIR}/desktop_backup"
          
          echo "=========================================="
          echo "üîÑ Desktop Sync Service Started"
          echo "=========================================="
          echo "Desktop Dir: $DESKTOP_DIR"
          echo "Backup Dir: $BACKUP_DIR"
          echo "=========================================="
          
          mkdir -p "$BACKUP_DIR"
          SYNC_COUNT=0
          
          sync_desktop() {
            SYNC_COUNT=$((SYNC_COUNT + 1))
            echo ""
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] üîç Sync check #${SYNC_COUNT}"
            
            FILE_COUNT=$(find "$DESKTOP_DIR" -type f 2>/dev/null | wc -l)
            echo "Files in Desktop: $FILE_COUNT"
            
            if [ "$FILE_COUNT" -gt 0 ]; then
              echo "üì¶ Syncing Desktop contents..."
              rsync -av --delete "$DESKTOP_DIR/" "$BACKUP_DIR/" 2>&1
              
              cd "$REPO_DIR"
              git add -A desktop_backup/
              
              if ! git diff --staged --quiet 2>/dev/null; then
                echo "üìù Committing changes..."
                git commit -m "Auto-sync Desktop - $(date '+%Y-%m-%d %H:%M:%S') - ${FILE_COUNT} files" 2>&1
                
                for i in {1..3}; do
                  echo "Attempting push (attempt $i/3)..."
                  git pull --rebase origin main 2>&1 || git pull --rebase origin master 2>&1 || true
                  
                  if git push 2>&1; then
                    echo "‚úÖ Desktop synced successfully!"
                    break
                  else
                    echo "‚ö†Ô∏è  Push failed, retrying in 5 seconds..."
                    sleep 5
                  fi
                done
              else
                echo "‚ÑπÔ∏è  No new changes to commit"
              fi
            else
              echo "‚ÑπÔ∏è  Desktop is empty"
            fi
          }
          
          sync_desktop
          
          while true; do
            sleep 60
            sync_desktop
          done
          SYNCEOF
          
          chmod +x /tmp/desktop_sync.sh
          /tmp/desktop_sync.sh 2>&1 | tee /tmp/desktop_sync.log &
          
          sleep 3
          echo "‚úÖ Desktop sync service started!"
          
      - name: Open LocalTunnel
        run: |
          echo "Opening tunnel via LocalTunnel..."
          
          # Start LocalTunnel for noVNC
          lt --port 6080 > /tmp/localtunnel.log 2>&1 &
          
          sleep 10
          
          # Extract URL
          TUNNEL_URL=$(grep -oE 'https://[a-z0-9-]+\.loca\.lt' /tmp/localtunnel.log | head -1)
          
          if [ -z "$TUNNEL_URL" ]; then
            # Try alternative extraction
            TUNNEL_URL=$(cat /tmp/localtunnel.log | grep -oE 'url is: https://[^ ]+' | cut -d' ' -f3)
          fi
          
          echo "============================================"
          echo "üì° LOCALTUNNEL URL"
          echo "============================================"
          echo "üåê Web (noVNC): ${TUNNEL_URL}/vnc.html"
          echo ""
          echo "üìã HOW TO CONNECT:"
          echo "1. Open: ${TUNNEL_URL}/vnc.html"
          echo "2. If you see 'Tunnel Password' page, click the button"
          echo "3. Click 'Connect' button"
          echo "4. Enter VNC password: password"
          echo ""
          echo "üíæ DESKTOP SYNC: Every 60 seconds ‚úÖ"
          echo "============================================"
          
          echo ""
          echo "Tunnel log:"
          cat /tmp/localtunnel.log
          
          echo ""
          echo "‚úÖ Session active for 6 hours..."
          
          for i in {1..72}; do
            sleep 300
            echo "[$(date)] Status update - Sync check #$((i*5))"
            tail -5 /tmp/desktop_sync.log
          done
          
      - name: Final Desktop sync
        if: always()
        run: |
          echo "üîÑ Final sync..."
          
          DESKTOP_DIR="/home/runner/Desktop"
          BACKUP_DIR="${GITHUB_WORKSPACE}/desktop_backup"
          
          FILE_COUNT=$(find "$DESKTOP_DIR" -type f 2>/dev/null | wc -l)
          
          if [ "$FILE_COUNT" -gt 0 ]; then
            mkdir -p "$BACKUP_DIR"
            rsync -av --delete "$DESKTOP_DIR/" "$BACKUP_DIR/"
            
            cd "${GITHUB_WORKSPACE}"
            git add -A desktop_backup/
            
            if ! git diff --staged --quiet; then
              git commit -m "üîö Final sync - $(date '+%Y-%m-%d %H:%M:%S') - ${FILE_COUNT} files"
              git pull --rebase origin main 2>/dev/null || git pull --rebase origin master 2>/dev/null || true
              git push || echo "‚ö†Ô∏è  Final push failed"
              echo "‚úÖ Final sync complete!"
            fi
          fi
