name: Ubuntu VNC

on: [workflow_dispatch]

jobs:
  tunnel:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          sudo apt update
          sudo DEBIAN_FRONTEND=noninteractive apt install -y \
            xfce4 xfce4-goodies x11vnc git openssh-client \
            tigervnc-standalone-server firefox net-tools
          
      - name: Start Xvfb display
        run: |
          Xvfb :1 -screen 0 1920x1080x24 &
          sleep 5
          export DISPLAY=:1
          echo "DISPLAY=:1" >> $GITHUB_ENV
          
      - name: Start XFCE session
        run: |
          export DISPLAY=:1
          startxfce4 &
          sleep 10
          
      - name: Configure VNC password
        run: |
          mkdir -p ~/.vnc
          echo "password" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          
      - name: Start VNC server
        run: |
          export DISPLAY=:1
          x11vnc -display :1 -rfbauth ~/.vnc/passwd -forever -shared -rfbport 5900 &
          sleep 5
          
      - name: Install noVNC
        run: |
          git clone https://github.com/novnc/noVNC.git ~/noVNC
          git clone https://github.com/novnc/websockify.git ~/noVNC/utils/websockify
          
      - name: Start noVNC
        run: |
          cd ~/noVNC
          ./utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
          sleep 5
          
      - name: Verify services
        run: |
          echo "Checking running processes:"
          ps aux | grep -E "(Xvfb|xfce|x11vnc|novnc)" | grep -v grep
          echo ""
          echo "Checking listening ports:"
          netstat -tlnp | grep -E "(5900|6080)"
          
      - name: Open Serveo tunnel
        run: |
          echo "Opening web tunnel via Serveo..."
          
          ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=60 \
              -R 80:localhost:6080 serveo.net 2>&1 | tee /tmp/serveo-web.log &
          
          sleep 10
          
          echo "============================================"
          echo "üì° SERVEO TUNNEL URL"
          echo "============================================"
          
          WEB_URL=$(grep -oE 'https://[a-z0-9]+\.serveo\.net' /tmp/serveo-web.log | head -1)
          
          echo "üåê Web (noVNC): ${WEB_URL}/vnc.html"
          echo ""
          echo "üìã HOW TO CONNECT:"
          echo "1. Open: ${WEB_URL}/vnc.html"
          echo "2. Click 'Connect'"
          echo "3. Enter password: password"
          echo "============================================"
          
          echo "Tunnel log:"
          cat /tmp/serveo-web.log
          
          echo "‚úÖ Keeping alive for 6 hours..."
          sleep 21600
